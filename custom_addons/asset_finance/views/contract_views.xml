<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Financial Contract Views -->
    <record id="view_asset_finance_contract_list" model="ir.ui.view">
        <field name="name">finance.contract.list</field>
        <field name="model">finance.contract</field>
        <field name="arch" type="xml">
            <list string="Financial Contracts">
                <field name="agreement_no"/>
                <field name="product_id"/>
                <!-- Uses product_type correctly -->
                <field name="product_type" optional="show"/>
                <field name="agreement_date"/>
                <field name="hirer_id"/>
                <field name="asset_reg_no"/>
                <field name="balance_hire"/>
                <field name="ac_status" widget="badge" decoration-success="ac_status == 'active'" decoration-muted="ac_status == 'closed'"/>
            </list>
        </field>
    </record>

    <!-- ACTIONS: Contract -->
    <record id="action_finance_contract" model="ir.actions.act_window">
        <field name="name">Contracts</field>
        <field name="res_model">finance.contract</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- ACTION: Invoices for Contract -->
    <record id="action_finance_contract_invoices" model="ir.actions.act_window">
        <field name="name">Contract Invoices</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('contract_id', '=', active_id)]</field>
        <field name="context">{'default_contract_id': active_id, 'default_move_type': 'out_invoice'}</field>
    </record>

    <!-- ACTION: Vouchers (Payments) for Contract -->
    <record id="action_finance_all_vouchers" model="ir.actions.act_window">
        <field name="name">Vouchers</field>
        <field name="res_model">account.payment</field>
        <field name="view_mode">list,kanban,form,graph</field>
        <field name="domain">[('contract_id', '=', active_id)]</field>
        <field name="context">{'default_contract_id': active_id}</field>
    </record>

    <record id="view_finance_contract_guarantor_form" model="ir.ui.view">
        <field name="name">finance.contract.guarantor.form</field>
        <field name="model">finance.contract.guarantor</field>
        <field name="arch" type="xml">
            <form string="Guarantor Details">
                <sheet>
                    <div class="oe_title">
                        <label for="partner_id" class="oe_edit_only"/>
                        <h1><field name="partner_id" placeholder="Select Guarantor..."/></h1>
                    </div>
                    <group>
                        <group string="Contact Details">
                            <field name="nric"/>
                            <field name="phone"/>
                            <field name="email"/>
                            <label for="street" string="Address"/>
                            <div class="o_address_format">
                                <field name="street" placeholder="Street..." class="o_address_street"/>
                                <field name="street2" placeholder="Street 2..." class="o_address_street"/>
                                <field name="city" placeholder="City" class="o_address_city"/>
                                <field name="zip" placeholder="ZIP" class="o_address_zip"/>
                            </div>
                        </group>
                        <group string="Compliance &amp; Verification">
                            <field name="relationship"/>
                            <separator string="Income Check"/>
                            <field name="income_verified" widget="boolean_toggle"/>
                            <field name="verification_date" invisible="not income_verified"/>
                        </group>
                    </group>
                    <group string="Notes">
                        <field name="remarks" placeholder="Enter compliance notes, verification details, etc."/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_finance_contract_joint_hirer_form" model="ir.ui.view">
        <field name="name">finance.contract.joint.hirer.form</field>
        <field name="model">finance.contract.joint.hirer</field>
        <field name="arch" type="xml">
            <form string="Co-Borrower Details">
                <sheet>
                    <div class="oe_title">
                        <h1><field name="partner_id"/></h1>
                    </div>
                    <group>
                        <group string="Contact Info">
                            <field name="nric"/>
                            <field name="phone"/>
                            <field name="email"/>
                        </group>
                        <group string="Loan Share">
                            <field name="relationship"/>
                            <field name="share_percentage"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_asset_finance_contract_form" model="ir.ui.view">
        <field name="name">finance.contract.form</field>
        <field name="model">finance.contract</field>
        <field name="arch" type="xml">
            <form string="Financial Contract">
                <header>
                    <button name="action_approve" string="Approve" type="object" class="oe_highlight" 
                            invisible="ac_status != 'draft'" groups="account.group_account_manager"/>
                    
                    <button name="action_generate_schedule" string="Compute Schedule" type="object" 
                        invisible="ac_status != 'draft'" class="btn-secondary"/>

                    <!-- Disbursement Action -->
                    <button name="action_disburse" string="Disbursement" type="object"
                        class="btn-primary" invisible="ac_status != 'active' or disbursement_move_id"/>

                    <button name="action_create_invoices" string="Post Due Invoices" type="object" 
                        invisible="ac_status != 'active'" class="btn-secondary"/>

                    <button name="action_early_settlement" string="Early Settlement" type="object" 
                        invisible="ac_status != 'active'" class="btn-warning"/>

                    <button name="action_close" string="Close Account" type="object" 
                            invisible="ac_status != 'active'"/>
                    
                    <button name="action_draft" string="Reset to Draft" type="object" 
                            invisible="ac_status == 'draft'"/>
                    
                    <field name="ac_status" widget="statusbar" statusbar_visible="draft,active,closed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(action_finance_contract_invoices)d" type="action" class="oe_stat_button" icon="fa-pencil-square-o">
                            <field name="invoice_count" widget="statinfo" string="Invoices"/>
                        </button>
                        <button name="%(action_finance_all_vouchers)d" type="action" class="oe_stat_button" icon="fa-money">
                            <field name="payment_count" widget="statinfo" string="Vouchers"/>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1><field name="agreement_no" placeholder="Agreement No"/></h1>
                    </div>
                    <group>
                        <group>
                            <field name="hirer_id"/>
                            <field name="asset_id"/>
                        </group>
                        <group>
                            <field name="agreement_date"/>
                            <field name="entry_date"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Main">
                            <group>
                                <group string="Agreement Details">
                                    <field name="product_id" options="{'no_create': True}"/>
                                    <!-- Using product_type here instead -->
                                    <field name="product_type" readonly="1"/>
                                    <field name="hp_ac_no"/>
                                    <field name="ic_no"/>
                                    
                                    <separator string="Guarantors &amp; Co-Borrowers" colspan="2"/>
                                    <field name="guarantor_line_ids" nolabel="1" colspan="2">
                                        <list string="Guarantors">
                                            <field name="partner_id"/>
                                            <field name="relationship"/>
                                            <field name="income_verified" widget="boolean_toggle"/>
                                            <field name="verification_date" optional="hide"/>
                                            <field name="remarks" optional="show"/>
                                        </list>
                                    </field>

                                    <field name="joint_hirer_line_ids" nolabel="1" colspan="2" class="mt-2">
                                        <list string="Co-Borrowers">
                                            <field name="partner_id"/>
                                            <field name="relationship"/>
                                            <field name="share_percentage"/>
                                        </list>
                                    </field>

                                    <field name="finance_company_id"/>
                                    <field name="submit_date"/>
                                    <field name="entry_staff_id"/>
                                </group>
                                <group string="Asset Info">
                                    <field name="asset_reg_no"/>
                                    <field name="asset_make"/>
                                    <field name="asset_model"/>
                                </group>
                                <group string="Terms">
                                    <field name="is_hp_act" decoration-danger="not is_hp_act" decoration-success="is_hp_act" widget="boolean_toggle"/>
                                    <field name="interest_method" widget="radio"/>
                                    <field name="payment_scheme" widget="radio"/>
                                    <field name="inst_day"/>
                                    <field name="period_type"/>
                                    <field name="late_status"/>
                                    <field name="cal_period"/>
                                </group>
                                <group string="Payment Setup">
                                    <field name="multi_purch"/>
                                    <field name="mortgage"/>
                                    <field name="advanced_payment"/>
                                    <field name="bank_acct"/>
                                </group>
                            </group>
                        </page>

                        <page string="Finance Info">
                            <group>
                                <group string="Loan Calculation">
                                    <field name="cash_price"/>
                                    <field name="down_payment"/>
                                    <field name="loan_amount" widget="monetary"/>
                                    <field name="int_rate_pa"/>
                                    <field name="no_of_inst"/>
                                    <field name="term_charges"/>
                                    <field name="balance_hire" class="oe_subtotal_footer_separator"/>
                                </group>
                                <group string="Leasing Parameters" invisible="product_type != 'lease'">
                                    <field name="residual_value_percent"/>
                                    <field name="residual_value"/>
                                    <field name="mileage_limit"/>
                                    <field name="excess_mileage_rate"/>
                                </group>
                                <group string="Installment Plan">
                                    <field name="first_inst_amount"/>
                                    <field name="monthly_inst"/>
                                    <field name="last_inst_amount"/>
                                </group>
                                <group string="Supplier / Dealer Info">
                                    <field name="supplier_id" context="{'default_supplier_rank': 1}"/>
                                    <field name="supplier_code"/>
                                    <field name="commission"/>
                                </group>
                                <group string="Accounting Setup" class="mt-4">
                                    <field name="journal_id"/>
                                    <field name="asset_account_id"/>
                                    <field name="unearned_interest_account_id"/>
                                    <field name="income_account_id"/>
                                    <field name="disbursement_move_id" readonly="1"/>
                                </group>
                            </group>
                        </page>

                        <page string="Repayment Schedule" name="schedule">
                            <field name="line_ids" readonly="ac_status != 'draft'">
                                <list editable="bottom" decoration-muted="state == 'posted'">
                                    <field name="sequence" widget="handle"/>
                                    <field name="date_due"/>
                                    <field name="amount_principal" sum="Total Principal"/>
                                    <field name="amount_interest" sum="Total Interest"/>
                                    <field name="amount_total" sum="Total Amount"/>
                                    <field name="invoice_id" widget="many2onebutton" optional="show"/>
                                    <field name="state" widget="badge" decoration-success="state == 'posted'" optional="show"/>
                                </list>
                            </field>
                        </page>

                        <page string="Paid">
                            <group>
                                <field name="no_inst_paid"/>
                                <field name="total_inst_paid"/>
                                <field name="total_late_paid"/>
                                <field name="balance_installment"/>
                                <field name="last_record_date"/>
                            </group>
                        </page>

                        <page string="O/S">
                            <group string="Outstanding Balances">
                                <field name="os_balance"/>
                                <field name="balance_late_charges"/>
                                <field name="balance_misc_fee"/>
                                <field name="total_payable" decoration-bf="1"/>
                                <field name="next_inst_date"/>
                            </group>
                            <group string="Penalty Status">
                                <field name="penalty_rule_id"/>
                                <field name="total_overdue_days" decoration-danger="total_overdue_days > 0"/>
                                <field name="accrued_penalty" widget="monetary" decoration-danger="accrued_penalty > 0"/>
                            </group>
                        </page>

                        <!-- Legal Notices Tab -->
                        <page string="Notices &amp; Legal" name="notices">
                            <group>
                                <group string="Collection Actions">
                                    <field name="date_reminder_sent"/>
                                    <button name="action_send_reminder" string="Send Reminder Notice" type="object" 
                                            class="btn-sm btn-secondary" invisible="date_reminder_sent"/>
                                    
                                    <field name="date_4th_sched_sent"/>
                                    <button name="action_send_4th_schedule" string="Issue 4th Schedule" type="object" 
                                            class="btn-sm btn-warning" invisible="date_4th_sched_sent"/>
                                </group>
                                <group string="Repossession">
                                    <field name="date_repo_order"/>
                                    <button name="action_issue_repo_order" string="Issue Repo Order" type="object" 
                                            class="btn-sm btn-danger" invisible="date_repo_order or ac_status == 'repo'"/>
                                    
                                    <field name="date_5th_sched_sent"/>
                                    <button name="action_send_5th_schedule" string="Issue 5th Schedule" type="object" 
                                            class="btn-sm btn-danger" invisible="not date_repo_order or date_5th_sched_sent"/>
                                </group>
                            </group>
                        </page>
                        <page string="Giro Application">
                            <group>
                                <field name="collection_bank_id"/>
                            </group>
                        </page>

                        <page string="Misc">
                            <group col="4">
                                <field name="first_due_date"/>
                                <!-- FIXED: Removed broken 'agreement_type' field -->
                                <field name="reference_no"/>
                                <field name="block_disc_no"/>
                                <field name="last_inst_date"/>
                                <field name="interest_derived"/>
                                <field name="block_status"/>
                            </group>
                            <group string="Fees Schedule">
                                <field name="search_fee"/>
                                <field name="reminder_fee"/>
                                <field name="schedule_4_fee"/>
                                <field name="schedule_5_fee"/>
                                <field name="warning_letter_fee"/>
                                <field name="final_letter_fee"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

</odoo>